f5e0e57f4b7970308ba790b057f23a88
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// Mock do UserService
jest.mock('../../src/services/userService');
const supertest_1 = __importDefault(require("supertest"));
const express_1 = __importDefault(require("express"));
const userService_1 = require("../../src/services/userService");
const mockUserService = userService_1.UserService;
describe('User Routes Integration', () => {
    let app;
    let mockUserServiceInstance;
    beforeEach(() => {
        app = (0, express_1.default)();
        app.use(express_1.default.json());
        // Criar instância mockada do UserService
        mockUserServiceInstance = {
            authenticateUser: jest.fn(),
            getAllUsers: jest.fn(),
            getUserById: jest.fn(),
            createUser: jest.fn(),
            updateUser: jest.fn(),
            deleteUser: jest.fn(),
            createCustomer: jest.fn(),
        };
        // Mock do UserController para usar nossa instância mockada
        const userController = {
            login: jest.fn().mockImplementation(async (req, res) => {
                try {
                    const result = await mockUserServiceInstance.authenticateUser(req.body.login, req.body.password);
                    res.json(result);
                }
                catch (error) {
                    res.status(401).json({ error: error.message });
                }
            }),
            getAllUsers: jest.fn().mockImplementation(async (req, res) => {
                try {
                    const users = await mockUserServiceInstance.getAllUsers();
                    res.json(users);
                }
                catch (error) {
                    res.status(500).json({ error: error.message });
                }
            }),
            getUserById: jest.fn().mockImplementation(async (req, res) => {
                try {
                    const user = await mockUserServiceInstance.getUserById(parseInt(req.params.id));
                    res.json(user);
                }
                catch (error) {
                    res.status(404).json({ error: error.message });
                }
            }),
            createUser: jest.fn().mockImplementation(async (req, res) => {
                try {
                    const user = await mockUserServiceInstance.createUser(req.body);
                    res.status(201).json({
                        id: user.id,
                        name: user.name,
                        mail: user.mail,
                        login: user.login,
                        role: user.role
                    });
                }
                catch (error) {
                    res.status(400).json({ error: error.message });
                }
            }),
            updateUser: jest.fn().mockImplementation(async (req, res) => {
                try {
                    const user = await mockUserServiceInstance.updateUser(parseInt(req.params.id), req.body);
                    res.json({
                        id: user.id,
                        name: user.name,
                        mail: user.mail,
                        role: user.role
                    });
                }
                catch (error) {
                    res.status(404).json({ error: error.message });
                }
            }),
            deleteUser: jest.fn().mockImplementation(async (req, res) => {
                try {
                    const result = await mockUserServiceInstance.deleteUser(parseInt(req.params.id));
                    res.json(result);
                }
                catch (error) {
                    res.status(404).json({ error: error.message });
                }
            }),
        };
        // Rotas de autenticação (públicas)
        app.post('/api/auth/login', userController.login.bind(userController));
        // Rotas protegidas (simulando middleware de auth)
        app.get('/api/users', (req, res, next) => {
            req.user = { id: 1, role: 'admin' };
            next();
        }, userController.getAllUsers.bind(userController));
        app.get('/api/users/:id', (req, res, next) => {
            req.user = { id: 1, role: 'admin' };
            next();
        }, userController.getUserById.bind(userController));
        app.post('/api/users', (req, res, next) => {
            req.user = { id: 1, role: 'admin' };
            next();
        }, userController.createUser.bind(userController));
        app.put('/api/users/:id', (req, res, next) => {
            req.user = { id: 1, role: 'admin' };
            next();
        }, userController.updateUser.bind(userController));
        app.delete('/api/users/:id', (req, res, next) => {
            req.user = { id: 1, role: 'admin' };
            next();
        }, userController.deleteUser.bind(userController));
        jest.clearAllMocks();
    });
    describe('POST /api/auth/login', () => {
        it('should login successfully', async () => {
            const loginData = {
                login: 'joao123',
                password: 'password123'
            };
            const loginResult = {
                user: {
                    id: 1,
                    name: 'João Silva',
                    mail: 'joao@test.com',
                    login: 'joao123',
                    role: 'customer'
                },
                token: 'jwt_token_123'
            };
            mockUserServiceInstance.authenticateUser.mockResolvedValue(loginResult);
            const response = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send(loginData)
                .expect(200);
            expect(response.body).toEqual(loginResult);
        });
        it('should return error for invalid credentials', async () => {
            const loginData = {
                login: 'invalid',
                password: 'wrong_password'
            };
            mockUserServiceInstance.authenticateUser.mockRejectedValue(new Error('Credenciais inválidas'));
            const response = await (0, supertest_1.default)(app)
                .post('/api/auth/login')
                .send(loginData)
                .expect(401);
            expect(response.body.error).toBe('Credenciais inválidas');
        });
    });
    describe('GET /api/users', () => {
        it('should return all users for admin', async () => {
            const users = [
                { id: 1, name: 'João', mail: 'joao@test.com', role: 'customer' },
                { id: 2, name: 'Maria', mail: 'maria@test.com', role: 'admin' }
            ];
            mockUserServiceInstance.getAllUsers.mockResolvedValue(users);
            const response = await (0, supertest_1.default)(app)
                .get('/api/users')
                .expect(200);
            expect(response.body).toEqual(users);
        });
        it('should handle service error', async () => {
            mockUserServiceInstance.getAllUsers.mockRejectedValue(new Error('Database error'));
            const response = await (0, supertest_1.default)(app)
                .get('/api/users')
                .expect(500);
            expect(response.body.error).toBe('Database error');
        });
    });
    describe('GET /api/users/:id', () => {
        it('should return user by id', async () => {
            const user = { id: 1, name: 'João', mail: 'joao@test.com', role: 'customer' };
            mockUserServiceInstance.getUserById.mockResolvedValue(user);
            const response = await (0, supertest_1.default)(app)
                .get('/api/users/1')
                .expect(200);
            expect(response.body).toEqual(user);
            expect(mockUserServiceInstance.getUserById).toHaveBeenCalledWith(1);
        });
        it('should return 404 for non-existent user', async () => {
            mockUserServiceInstance.getUserById.mockRejectedValue(new Error('Usuário não encontrado'));
            const response = await (0, supertest_1.default)(app)
                .get('/api/users/999')
                .expect(404);
            expect(response.body.error).toBe('Usuário não encontrado');
        });
    });
    describe('POST /api/users', () => {
        it('should create user successfully', async () => {
            const userData = {
                name: 'João Silva',
                mail: 'joao@test.com',
                login: 'joao123',
                password: 'password123',
                role: 'customer'
            };
            const createdUser = {
                id: 1,
                name: userData.name,
                mail: userData.mail,
                login: userData.login,
                role: userData.role
            };
            mockUserServiceInstance.createUser.mockResolvedValue(createdUser);
            const response = await (0, supertest_1.default)(app)
                .post('/api/users')
                .send(userData)
                .expect(201);
            expect(response.body).toEqual({
                id: createdUser.id,
                name: createdUser.name,
                mail: createdUser.mail,
                login: createdUser.login,
                role: createdUser.role
            });
        });
    });
    describe('PUT /api/users/:id', () => {
        it('should update user successfully', async () => {
            const updateData = { name: 'João Santos' };
            const updatedUser = { id: 1, name: 'João Santos', mail: 'joao@test.com', role: 'customer' };
            mockUserServiceInstance.updateUser.mockResolvedValue(updatedUser);
            const response = await (0, supertest_1.default)(app)
                .put('/api/users/1')
                .send(updateData)
                .expect(200);
            expect(response.body).toEqual({
                id: updatedUser.id,
                name: updatedUser.name,
                mail: updatedUser.mail,
                role: updatedUser.role
            });
            expect(mockUserServiceInstance.updateUser).toHaveBeenCalledWith(1, updateData);
        });
    });
    describe('DELETE /api/users/:id', () => {
        it('should delete user successfully', async () => {
            mockUserServiceInstance.deleteUser.mockResolvedValue({ message: 'Usuário deletado com sucesso' });
            const response = await (0, supertest_1.default)(app)
                .delete('/api/users/1')
                .expect(200);
            expect(response.body).toEqual({ message: 'Usuário deletado com sucesso' });
            expect(mockUserServiceInstance.deleteUser).toHaveBeenCalledWith(1);
        });
        it('should return 404 for non-existent user', async () => {
            mockUserServiceInstance.deleteUser.mockRejectedValue(new Error('Usuário não encontrado'));
            const response = await (0, supertest_1.default)(app)
                .delete('/api/users/999')
                .expect(404);
            expect(response.body.error).toBe('Usuário não encontrado');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRTpcXEN1cnNvIEpTXFxEZXBsb3lcXENvbW1lcmNlXFxiYWNrZW5kXFx0ZXN0c1xcaW50ZWdyYXRpb25cXHVzZXJSb3V0ZXMudGVzdC50cyIsIm1hcHBpbmdzIjoiOzs7OztBQUtBLHNCQUFzQjtBQUN0QixJQUFJLENBQUMsSUFBSSxDQUFDLGdDQUFnQyxDQUFDLENBQUM7QUFONUMsMERBQWdDO0FBQ2hDLHNEQUE4QjtBQUU5QixnRUFBNkQ7QUFJN0QsTUFBTSxlQUFlLEdBQUcseUJBQW1ELENBQUM7QUFFNUUsUUFBUSxDQUFDLHlCQUF5QixFQUFFLEdBQUcsRUFBRTtJQUN2QyxJQUFJLEdBQXdCLENBQUM7SUFDN0IsSUFBSSx1QkFBaUQsQ0FBQztJQUV0RCxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsR0FBRyxHQUFHLElBQUEsaUJBQU8sR0FBRSxDQUFDO1FBQ2hCLEdBQUcsQ0FBQyxHQUFHLENBQUMsaUJBQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRXhCLHlDQUF5QztRQUN6Qyx1QkFBdUIsR0FBRztZQUN4QixnQkFBZ0IsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQzNCLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3RCLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3RCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3JCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3JCLFVBQVUsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3JCLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQ0UsQ0FBQztRQUU5QiwyREFBMkQ7UUFDM0QsTUFBTSxjQUFjLEdBQUc7WUFDckIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLEVBQUUsR0FBUSxFQUFFLEdBQVEsRUFBRSxFQUFFO2dCQUMvRCxJQUFJLENBQUM7b0JBQ0gsTUFBTSxNQUFNLEdBQUcsTUFBTSx1QkFB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R0FBRyxDQUFDO2lCQUNoQyxNQUFNLENBQUMsZ0JBQWdCLENBQUM7aUJBQ3hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVmLE1BQU0sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBQzdELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJFOlxcQ3Vyc28gSlNcXERlcGxveVxcQ29tbWVyY2VcXGJhY2tlbmRcXHRlc3RzXFxpbnRlZ3JhdGlvblxcdXNlclJvdXRlcy50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCByZXF1ZXN0IGZyb20gJ3N1cGVydGVzdCc7XHJcbmltcG9ydCBleHByZXNzIGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgeyBVc2VyQ29udHJvbGxlciB9IGZyb20gJy4uLy4uL3NyYy9jb250cm9sbGVycy91c2VyQ29udHJvbGxlcic7XHJcbmltcG9ydCB7IFVzZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc3JjL3NlcnZpY2VzL3VzZXJTZXJ2aWNlJztcclxuXHJcbi8vIE1vY2sgZG8gVXNlclNlcnZpY2VcclxuamVzdC5tb2NrKCcuLi8uLi9zcmMvc2VydmljZXMvdXNlclNlcnZpY2UnKTtcclxuY29uc3QgbW9ja1VzZXJTZXJ2aWNlID0gVXNlclNlcnZpY2UgYXMgamVzdC5Nb2NrZWRDbGFzczx0eXBlb2YgVXNlclNlcnZpY2U+O1xyXG5cclxuZGVzY3JpYmUoJ1VzZXIgUm91dGVzIEludGVncmF0aW9uJywgKCkgPT4ge1xyXG4gIGxldCBhcHA6IGV4cHJlc3MuQXBwbGljYXRpb247XHJcbiAgbGV0IG1vY2tVc2VyU2VydmljZUluc3RhbmNlOiBqZXN0Lk1vY2tlZDxVc2VyU2VydmljZT47XHJcblxyXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgYXBwID0gZXhwcmVzcygpO1xyXG4gICAgYXBwLnVzZShleHByZXNzLmpzb24oKSk7XHJcbiAgICBcclxuICAgIC8vIENyaWFyIGluc3TDom5jaWEgbW9ja2FkYSBkbyBVc2VyU2VydmljZVxyXG4gICAgbW9ja1VzZXJTZXJ2aWNlSW5zdGFuY2UgPSB7XHJcbiAgICAgIGF1dGhlbnRpY2F0ZVVzZXI6IGplc3QuZm4oKSxcclxuICAgICAgZ2V0QWxsVXNlcnM6IGplc3QuZm4oKSxcclxuICAgICAgZ2V0VXNlckJ5SWQ6IGplc3QuZm4oKSxcclxuICAgICAgY3JlYXRlVXNlcjogamVzdC5mbigpLFxyXG4gICAgICB1cGRhdGVVc2VyOiBqZXN0LmZuKCksXHJcbiAgICAgIGRlbGV0ZVVzZXI6IGplc3QuZm4oKSxcclxuICAgICAgY3JlYXRlQ3VzdG9tZXI6IGplc3QuZm4oKSxcclxuICAgIH0gYXMgamVzdC5Nb2NrZWQ8VXNlclNlcnZpY2U+O1xyXG4gICAgXHJcbiAgICAvLyBNb2NrIGRvIFVzZXJDb250cm9sbGVyIHBhcmEgdXNhciBub3NzYSBpbnN0w6JuY2lhIG1vY2thZGFcclxuICAgIGNvbnN0IHVzZXJDb250cm9sbGVyID0ge1xyXG4gICAgICBsb2dpbjogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IG1vY2tVc2VyU2VydmljZUluc3RhbmNlLmF1dGhlbnRpY2F0ZVVzZXIocmVxLmJvZHkubG9naW4sIHJlcS5ib2R5LnBhc3N3b3JkKTtcclxuICAgICAgICAgIHJlcy5qc29uKHJlc3VsdCk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICAgICAgcmVzLnN0YXR1cyg0MDEpLmpzb24oeyBlcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBnZXRBbGxVc2VyczogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNvbnN0IHVzZXJzID0gYXdhaXQgbW9ja1VzZXJTZXJ2aWNlSW5zdGFuY2UuZ2V0QWxsVXNlcnMoKTtcclxuICAgICAgICAgIHJlcy5qc29uKHVzZXJzKTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgICAgICByZXMuc3RhdHVzKDUwMCkuanNvbih7IGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICAgIGdldFVzZXJCeUlkOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IG1vY2tVc2VyU2VydmljZUluc3RhbmNlLmdldFVzZXJCeUlkKHBhcnNlSW50KHJlcS5wYXJhbXMuaWQpKTtcclxuICAgICAgICAgIHJlcy5qc29uKHVzZXIpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgICAgY3JlYXRlVXNlcjogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAocmVxOiBhbnksIHJlczogYW55KSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS5jcmVhdGVVc2VyKHJlcS5ib2R5KTtcclxuICAgICAgICAgIHJlcy5zdGF0dXMoMjAxKS5qc29uKHtcclxuICAgICAgICAgICAgaWQ6IHVzZXIuaWQsXHJcbiAgICAgICAgICAgIG5hbWU6IHVzZXIubmFtZSxcclxuICAgICAgICAgICAgbWFpbDogdXNlci5tYWlsLFxyXG4gICAgICAgICAgICBsb2dpbjogdXNlci5sb2dpbixcclxuICAgICAgICAgICAgcm9sZTogdXNlci5yb2xlXHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XHJcbiAgICAgICAgICByZXMuc3RhdHVzKDQwMCkuanNvbih7IGVycm9yOiBlcnJvci5tZXNzYWdlIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSksXHJcbiAgICAgIHVwZGF0ZVVzZXI6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKHJlcTogYW55LCByZXM6IGFueSkgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgbW9ja1VzZXJTZXJ2aWNlSW5zdGFuY2UudXBkYXRlVXNlcihwYXJzZUludChyZXEucGFyYW1zLmlkKSwgcmVxLmJvZHkpO1xyXG4gICAgICAgICAgcmVzLmpzb24oe1xyXG4gICAgICAgICAgICBpZDogdXNlci5pZCxcclxuICAgICAgICAgICAgbmFtZTogdXNlci5uYW1lLFxyXG4gICAgICAgICAgICBtYWlsOiB1c2VyLm1haWwsXHJcbiAgICAgICAgICAgIHJvbGU6IHVzZXIucm9sZVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xyXG4gICAgICAgICAgcmVzLnN0YXR1cyg0MDQpLmpzb24oeyBlcnJvcjogZXJyb3IubWVzc2FnZSB9KTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pLFxyXG4gICAgICBkZWxldGVVc2VyOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChyZXE6IGFueSwgcmVzOiBhbnkpID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgbW9ja1VzZXJTZXJ2aWNlSW5zdGFuY2UuZGVsZXRlVXNlcihwYXJzZUludChyZXEucGFyYW1zLmlkKSk7XHJcbiAgICAgICAgICByZXMuanNvbihyZXN1bHQpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcclxuICAgICAgICAgIHJlcy5zdGF0dXMoNDA0KS5qc29uKHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KSxcclxuICAgIH07XHJcblxyXG4gICAgLy8gUm90YXMgZGUgYXV0ZW50aWNhw6fDo28gKHDDumJsaWNhcylcclxuICAgIGFwcC5wb3N0KCcvYXBpL2F1dGgvbG9naW4nLCB1c2VyQ29udHJvbGxlci5sb2dpbi5iaW5kKHVzZXJDb250cm9sbGVyKSk7XHJcblxyXG4gICAgLy8gUm90YXMgcHJvdGVnaWRhcyAoc2ltdWxhbmRvIG1pZGRsZXdhcmUgZGUgYXV0aClcclxuICAgIGFwcC5nZXQoJy9hcGkvdXNlcnMnLCAocmVxOiBhbnksIHJlcywgbmV4dCkgPT4ge1xyXG4gICAgICByZXEudXNlciA9IHsgaWQ6IDEsIHJvbGU6ICdhZG1pbicgfTtcclxuICAgICAgbmV4dCgpO1xyXG4gICAgfSwgdXNlckNvbnRyb2xsZXIuZ2V0QWxsVXNlcnMuYmluZCh1c2VyQ29udHJvbGxlcikpO1xyXG5cclxuICAgIGFwcC5nZXQoJy9hcGkvdXNlcnMvOmlkJywgKHJlcTogYW55LCByZXMsIG5leHQpID0+IHtcclxuICAgICAgcmVxLnVzZXIgPSB7IGlkOiAxLCByb2xlOiAnYWRtaW4nIH07XHJcbiAgICAgIG5leHQoKTtcclxuICAgIH0sIHVzZXJDb250cm9sbGVyLmdldFVzZXJCeUlkLmJpbmQodXNlckNvbnRyb2xsZXIpKTtcclxuXHJcbiAgICBhcHAucG9zdCgnL2FwaS91c2VycycsIChyZXE6IGFueSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICAgIHJlcS51c2VyID0geyBpZDogMSwgcm9sZTogJ2FkbWluJyB9O1xyXG4gICAgICBuZXh0KCk7XHJcbiAgICB9LCB1c2VyQ29udHJvbGxlci5jcmVhdGVVc2VyLmJpbmQodXNlckNvbnRyb2xsZXIpKTtcclxuXHJcbiAgICBhcHAucHV0KCcvYXBpL3VzZXJzLzppZCcsIChyZXE6IGFueSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICAgIHJlcS51c2VyID0geyBpZDogMSwgcm9sZTogJ2FkbWluJyB9O1xyXG4gICAgICBuZXh0KCk7XHJcbiAgICB9LCB1c2VyQ29udHJvbGxlci51cGRhdGVVc2VyLmJpbmQodXNlckNvbnRyb2xsZXIpKTtcclxuXHJcbiAgICBhcHAuZGVsZXRlKCcvYXBpL3VzZXJzLzppZCcsIChyZXE6IGFueSwgcmVzLCBuZXh0KSA9PiB7XHJcbiAgICAgIHJlcS51c2VyID0geyBpZDogMSwgcm9sZTogJ2FkbWluJyB9O1xyXG4gICAgICBuZXh0KCk7XHJcbiAgICB9LCB1c2VyQ29udHJvbGxlci5kZWxldGVVc2VyLmJpbmQodXNlckNvbnRyb2xsZXIpKTtcclxuXHJcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ1BPU1QgL2FwaS9hdXRoL2xvZ2luJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBsb2dpbiBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGxvZ2luRGF0YSA9IHtcclxuICAgICAgICBsb2dpbjogJ2pvYW8xMjMnLFxyXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBjb25zdCBsb2dpblJlc3VsdCA9IHtcclxuICAgICAgICB1c2VyOiB7XHJcbiAgICAgICAgICBpZDogMSxcclxuICAgICAgICAgIG5hbWU6ICdKb8OjbyBTaWx2YScsXHJcbiAgICAgICAgICBtYWlsOiAnam9hb0B0ZXN0LmNvbScsXHJcbiAgICAgICAgICBsb2dpbjogJ2pvYW8xMjMnLFxyXG4gICAgICAgICAgcm9sZTogJ2N1c3RvbWVyJ1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgdG9rZW46ICdqd3RfdG9rZW5fMTIzJ1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgbW9ja1VzZXJTZXJ2aWNlSW5zdGFuY2UuYXV0aGVudGljYXRlVXNlci5tb2NrUmVzb2x2ZWRWYWx1ZShsb2dpblJlc3VsdCBhcyBhbnkpO1xyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcclxuICAgICAgICAucG9zdCgnL2FwaS9hdXRoL2xvZ2luJylcclxuICAgICAgICAuc2VuZChsb2dpbkRhdGEpXHJcbiAgICAgICAgLmV4cGVjdCgyMDApO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvRXF1YWwobG9naW5SZXN1bHQpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gZXJyb3IgZm9yIGludmFsaWQgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGxvZ2luRGF0YSA9IHtcclxuICAgICAgICBsb2dpbjogJ2ludmFsaWQnLFxyXG4gICAgICAgIHBhc3N3b3JkOiAnd3JvbmdfcGFzc3dvcmQnXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS5hdXRoZW50aWNhdGVVc2VyLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignQ3JlZGVuY2lhaXMgaW52w6FsaWRhcycpKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXHJcbiAgICAgICAgLnBvc3QoJy9hcGkvYXV0aC9sb2dpbicpXHJcbiAgICAgICAgLnNlbmQobG9naW5EYXRhKVxyXG4gICAgICAgIC5leHBlY3QoNDAxKTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmVycm9yKS50b0JlKCdDcmVkZW5jaWFpcyBpbnbDoWxpZGFzJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ0dFVCAvYXBpL3VzZXJzJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gYWxsIHVzZXJzIGZvciBhZG1pbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXNlcnMgPSBbXHJcbiAgICAgICAgeyBpZDogMSwgbmFtZTogJ0pvw6NvJywgbWFpbDogJ2pvYW9AdGVzdC5jb20nLCByb2xlOiAnY3VzdG9tZXInIH0sXHJcbiAgICAgICAgeyBpZDogMiwgbmFtZTogJ01hcmlhJywgbWFpbDogJ21hcmlhQHRlc3QuY29tJywgcm9sZTogJ2FkbWluJyB9XHJcbiAgICAgIF07XHJcblxyXG4gICAgICBtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS5nZXRBbGxVc2Vycy5tb2NrUmVzb2x2ZWRWYWx1ZSh1c2VycyBhcyBhbnkpO1xyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcclxuICAgICAgICAuZ2V0KCcvYXBpL3VzZXJzJylcclxuICAgICAgICAuZXhwZWN0KDIwMCk7XHJcblxyXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9FcXVhbCh1c2Vycyk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBzZXJ2aWNlIGVycm9yJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS5nZXRBbGxVc2Vycy5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ0RhdGFiYXNlIGVycm9yJykpO1xyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcclxuICAgICAgICAuZ2V0KCcvYXBpL3VzZXJzJylcclxuICAgICAgICAuZXhwZWN0KDUwMCk7XHJcblxyXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5lcnJvcikudG9CZSgnRGF0YWJhc2UgZXJyb3InKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnR0VUIC9hcGkvdXNlcnMvOmlkJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdXNlciBieSBpZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXNlciA9IHsgaWQ6IDEsIG5hbWU6ICdKb8OjbycsIG1haWw6ICdqb2FvQHRlc3QuY29tJywgcm9sZTogJ2N1c3RvbWVyJyB9O1xyXG4gICAgICBtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS5nZXRVc2VyQnlJZC5tb2NrUmVzb2x2ZWRWYWx1ZSh1c2VyIGFzIGFueSk7XHJcblxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxyXG4gICAgICAgIC5nZXQoJy9hcGkvdXNlcnMvMScpXHJcbiAgICAgICAgLmV4cGVjdCgyMDApO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvRXF1YWwodXNlcik7XHJcbiAgICAgIGV4cGVjdChtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS5nZXRVc2VyQnlJZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoMSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHJldHVybiA0MDQgZm9yIG5vbi1leGlzdGVudCB1c2VyJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS5nZXRVc2VyQnlJZC5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ1VzdcOhcmlvIG7Do28gZW5jb250cmFkbycpKTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXHJcbiAgICAgICAgLmdldCgnL2FwaS91c2Vycy85OTknKVxyXG4gICAgICAgIC5leHBlY3QoNDA0KTtcclxuXHJcbiAgICAgIGV4cGVjdChyZXNwb25zZS5ib2R5LmVycm9yKS50b0JlKCdVc3XDoXJpbyBuw6NvIGVuY29udHJhZG8nKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnUE9TVCAvYXBpL3VzZXJzJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgdXNlciBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHVzZXJEYXRhID0ge1xyXG4gICAgICAgIG5hbWU6ICdKb8OjbyBTaWx2YScsXHJcbiAgICAgICAgbWFpbDogJ2pvYW9AdGVzdC5jb20nLFxyXG4gICAgICAgIGxvZ2luOiAnam9hbzEyMycsXHJcbiAgICAgICAgcGFzc3dvcmQ6ICdwYXNzd29yZDEyMycsXHJcbiAgICAgICAgcm9sZTogJ2N1c3RvbWVyJ1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgY3JlYXRlZFVzZXIgPSB7XHJcbiAgICAgICAgaWQ6IDEsXHJcbiAgICAgICAgbmFtZTogdXNlckRhdGEubmFtZSxcclxuICAgICAgICBtYWlsOiB1c2VyRGF0YS5tYWlsLFxyXG4gICAgICAgIGxvZ2luOiB1c2VyRGF0YS5sb2dpbixcclxuICAgICAgICByb2xlOiB1c2VyRGF0YS5yb2xlXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS5jcmVhdGVVc2VyLm1vY2tSZXNvbHZlZFZhbHVlKGNyZWF0ZWRVc2VyIGFzIGFueSk7XHJcblxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxyXG4gICAgICAgIC5wb3N0KCcvYXBpL3VzZXJzJylcclxuICAgICAgICAuc2VuZCh1c2VyRGF0YSlcclxuICAgICAgICAuZXhwZWN0KDIwMSk7XHJcblxyXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9FcXVhbCh7XHJcbiAgICAgICAgaWQ6IGNyZWF0ZWRVc2VyLmlkLFxyXG4gICAgICAgIG5hbWU6IGNyZWF0ZWRVc2VyLm5hbWUsXHJcbiAgICAgICAgbWFpbDogY3JlYXRlZFVzZXIubWFpbCxcclxuICAgICAgICBsb2dpbjogY3JlYXRlZFVzZXIubG9naW4sXHJcbiAgICAgICAgcm9sZTogY3JlYXRlZFVzZXIucm9sZVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnUFVUIC9hcGkvdXNlcnMvOmlkJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCB1cGRhdGUgdXNlciBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHVwZGF0ZURhdGEgPSB7IG5hbWU6ICdKb8OjbyBTYW50b3MnIH07XHJcbiAgICAgIGNvbnN0IHVwZGF0ZWRVc2VyID0geyBpZDogMSwgbmFtZTogJ0pvw6NvIFNhbnRvcycsIG1haWw6ICdqb2FvQHRlc3QuY29tJywgcm9sZTogJ2N1c3RvbWVyJyB9O1xyXG5cclxuICAgICAgbW9ja1VzZXJTZXJ2aWNlSW5zdGFuY2UudXBkYXRlVXNlci5tb2NrUmVzb2x2ZWRWYWx1ZSh1cGRhdGVkVXNlciBhcyBhbnkpO1xyXG5cclxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KGFwcClcclxuICAgICAgICAucHV0KCcvYXBpL3VzZXJzLzEnKVxyXG4gICAgICAgIC5zZW5kKHVwZGF0ZURhdGEpXHJcbiAgICAgICAgLmV4cGVjdCgyMDApO1xyXG5cclxuICAgICAgZXhwZWN0KHJlc3BvbnNlLmJvZHkpLnRvRXF1YWwoe1xyXG4gICAgICAgIGlkOiB1cGRhdGVkVXNlci5pZCxcclxuICAgICAgICBuYW1lOiB1cGRhdGVkVXNlci5uYW1lLFxyXG4gICAgICAgIG1haWw6IHVwZGF0ZWRVc2VyLm1haWwsXHJcbiAgICAgICAgcm9sZTogdXBkYXRlZFVzZXIucm9sZVxyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIGV4cGVjdChtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS51cGRhdGVVc2VyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgxLCB1cGRhdGVEYXRhKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnREVMRVRFIC9hcGkvdXNlcnMvOmlkJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBkZWxldGUgdXNlciBzdWNjZXNzZnVsbHknLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tVc2VyU2VydmljZUluc3RhbmNlLmRlbGV0ZVVzZXIubW9ja1Jlc29sdmVkVmFsdWUoeyBtZXNzYWdlOiAnVXN1w6FyaW8gZGVsZXRhZG8gY29tIHN1Y2Vzc28nIH0gYXMgYW55KTtcclxuXHJcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdChhcHApXHJcbiAgICAgICAgLmRlbGV0ZSgnL2FwaS91c2Vycy8xJylcclxuICAgICAgICAuZXhwZWN0KDIwMCk7XHJcblxyXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keSkudG9FcXVhbCh7IG1lc3NhZ2U6ICdVc3XDoXJpbyBkZWxldGFkbyBjb20gc3VjZXNzbycgfSk7XHJcbiAgICAgIGV4cGVjdChtb2NrVXNlclNlcnZpY2VJbnN0YW5jZS5kZWxldGVVc2VyKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgxKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIDQwNCBmb3Igbm9uLWV4aXN0ZW50IHVzZXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tVc2VyU2VydmljZUluc3RhbmNlLmRlbGV0ZVVzZXIubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCdVc3XDoXJpbyBuw6NvIGVuY29udHJhZG8nKSk7XHJcblxyXG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3QoYXBwKVxyXG4gICAgICAgIC5kZWxldGUoJy9hcGkvdXNlcnMvOTk5JylcclxuICAgICAgICAuZXhwZWN0KDQwNCk7XHJcblxyXG4gICAgICBleHBlY3QocmVzcG9uc2UuYm9keS5lcnJvcikudG9CZSgnVXN1w6FyaW8gbsOjbyBlbmNvbnRyYWRvJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7Il0sInZlcnNpb24iOjN9