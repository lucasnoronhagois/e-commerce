ce2176ef01f00026a290834b30832ed8
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
// Mock dos modelos
jest.mock('../../src/models/User');
jest.mock('../../src/models/CustomerDetail');
jest.mock('bcrypt');
jest.mock('jsonwebtoken');
const userService_1 = require("../../src/services/userService");
const User_1 = __importDefault(require("../../src/models/User"));
const models_1 = require("../../src/models");
const bcrypt_1 = __importDefault(require("bcrypt"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const mockUser = User_1.default;
const mockCustomerDetail = models_1.CustomerDetail;
const mockBcrypt = bcrypt_1.default;
const mockJwt = jsonwebtoken_1.default;
describe('UserService', () => {
    let userService;
    beforeEach(() => {
        userService = new userService_1.UserService();
        jest.clearAllMocks();
    });
    describe('createUser', () => {
        it('should create a user successfully', async () => {
            const userData = {
                name: 'João Silva',
                mail: 'joao@test.com',
                login: 'joao123',
                password: 'password123',
                role: 'customer'
            };
            const hashedPassword = 'hashed_password_123';
            const createdUser = {
                id: 1,
                ...userData,
                password: hashedPassword,
                is_deleted: false,
                created_at: new Date(),
                updated_at: new Date()
            };
            mockBcrypt.hash.mockResolvedValue(hashedPassword);
            mockUser.findOne.mockResolvedValue(null);
            mockUser.create.mockResolvedValue(createdUser);
            const result = await userService.createUser(userData);
            expect(mockBcrypt.hash).toHaveBeenCalledWith(userData.password, 10);
            expect(mockUser.findOne).toHaveBeenCalledWith({
                where: expect.objectContaining({
                    [Symbol.for('or')]: [
                        { login: userData.login },
                        { mail: userData.mail }
                    ]
                })
            });
            expect(mockUser.create).toHaveBeenCalledWith({
                ...userData,
                password: hashedPassword,
                role: 'customer'
            });
            expect(result).toEqual(createdUser);
        });
        it('should throw error if user already exists', async () => {
            const userData = {
                name: 'João Silva',
                mail: 'joao@test.com',
                login: 'joao123',
                password: 'password123'
            };
            const existingUser = { id: 1, login: 'joao123' };
            mockUser.findOne.mockResolvedValue(existingUser);
            await expect(userService.createUser(userData)).rejects.toThrow('Login ou email já existem');
        });
        it('should set default role as customer', async () => {
            const userData = {
                name: 'João Silva',
                mail: 'joao@test.com',
                login: 'joao123',
                password: 'password123'
            };
            const hashedPassword = 'hashed_password_123';
            const createdUser = {
                id: 1,
                ...userData,
                password: hashedPassword,
                role: 'customer'
            };
            mockBcrypt.hash.mockResolvedValue(hashedPassword);
            mockUser.findOne.mockResolvedValue(null);
            mockUser.create.mockResolvedValue(createdUser);
            await userService.createUser(userData);
            expect(mockUser.create).toHaveBeenCalledWith({
                ...userData,
                password: hashedPassword,
                role: 'customer'
            });
        });
    });
    describe('getAllUsers', () => {
        it('should return all users', async () => {
            const users = [
                { id: 1, name: 'João', mail: 'joao@test.com', role: 'customer' },
                { id: 2, name: 'Maria', mail: 'maria@test.com', role: 'admin' }
            ];
            mockUser.findAll.mockResolvedValue(users);
            const result = await userService.getAllUsers();
            expect(mockUser.findAll).toHaveBeenCalledWith({
                where: { is_deleted: false },
                attributes: { exclude: ['password'] }
            });
            expect(result).toEqual(users);
        });
    });
    describe('getUserById', () => {
        it('should return user by id', async () => {
            const user = { id: 1, name: 'João', mail: 'joao@test.com', role: 'customer' };
            mockUser.findOne.mockResolvedValue(user);
            const result = await userService.getUserById(1);
            expect(mockUser.findOne).toHaveBeenCalledWith({
                where: { id: 1, is_deleted: false },
                attributes: { exclude: ['password'] }
            });
            expect(result).toEqual(user);
        });
        it('should throw error if user not found', async () => {
            mockUser.findOne.mockResolvedValue(null);
            await expect(userService.getUserById(999)).rejects.toThrow('Usuário não encontrado');
        });
    });
    describe('updateUser', () => {
        it('should update user successfully', async () => {
            const userData = { name: 'João Santos' };
            const existingUser = {
                id: 1,
                name: 'João Silva',
                mail: 'joao@test.com',
                update: jest.fn().mockResolvedValue({ id: 1, ...userData })
            };
            mockUser.findOne.mockResolvedValue(existingUser);
            const result = await userService.updateUser(1, userData);
            expect(existingUser.update).toHaveBeenCalledWith(userData);
            expect(result).toEqual({ id: 1, ...userData });
        });
        it('should throw error if user not found', async () => {
            mockUser.findOne.mockResolvedValue(null);
            await expect(userService.updateUser(999, { name: 'Test' })).rejects.toThrow('Usuário não encontrado');
        });
    });
    describe('deleteUser', () => {
        it('should soft delete user', async () => {
            const existingUser = {
                id: 1,
                name: 'João Silva',
                update: jest.fn().mockResolvedValue({ id: 1, is_deleted: true })
            };
            mockUser.findOne.mockResolvedValue(existingUser);
            const result = await userService.deleteUser(1);
            expect(existingUser.update).toHaveBeenCalledWith({ is_deleted: true });
            expect(result).toEqual({ message: 'Usuário deletado com sucesso' });
        });
        it('should throw error if user not found', async () => {
            mockUser.findOne.mockResolvedValue(null);
            await expect(userService.deleteUser(999)).rejects.toThrow('Usuário não encontrado');
        });
    });
    describe('authenticateUser', () => {
        it('should authenticate user successfully with valid credentials', async () => {
            const login = 'joao123';
            const password = 'password123';
            const user = {
                id: 1,
                name: 'João Silva',
                mail: 'joao@test.com',
                login: 'joao123',
                password: 'hashed_password',
                role: 'customer'
            };
            const token = 'jwt_token_123';
            mockUser.findOne.mockResolvedValue(user);
            mockBcrypt.compare.mockResolvedValue(true);
            mockJwt.sign.mockReturnValue(token);
            const result = await userService.authenticateUser(login, password);
            expect(mockUser.findOne).toHaveBeenCalledWith({
                where: { login, is_deleted: false },
                include: [{ association: 'customerDetail', required: false }]
            });
            expect(mockBcrypt.compare).toHaveBeenCalledWith(password, user.password);
            expect(mockJwt.sign).toHaveBeenCalledWith({ id: user.id, login: user.login, role: user.role }, process.env.JWT_SECRET, { expiresIn: process.env.JWT_EXPIRES_IN });
            expect(result).toEqual({
                user: {
                    id: user.id,
                    name: user.name,
                    mail: user.mail,
                    login: user.login,
                    role: user.role
                },
                token
            });
        });
        it('should throw error for invalid login', async () => {
            const login = 'invalid';
            const password = 'password123';
            mockUser.findOne.mockResolvedValue(null);
            await expect(userService.authenticateUser(login, password)).rejects.toThrow('Credenciais inválidas');
        });
        it('should throw error for invalid password', async () => {
            const login = 'joao123';
            const password = 'wrong_password';
            const user = {
                id: 1,
                name: 'João Silva',
                password: 'hashed_password'
            };
            mockUser.findOne.mockResolvedValue(user);
            mockBcrypt.compare.mockResolvedValue(false);
            await expect(userService.authenticateUser(login, password)).rejects.toThrow('Credenciais inválidas');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiRTpcXEN1cnNvIEpTXFxEZXBsb3lcXENvbW1lcmNlXFxiYWNrZW5kXFx0ZXN0c1xcc2VydmljZXNcXHVzZXJTZXJ2aWNlLnRlc3QudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7QUFNQSxtQkFBbUI7QUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBQ25DLElBQUksQ0FBQyxJQUFJLENBQUMsaUNBQWlDLENBQUMsQ0FBQztBQUM3QyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7QUFWMUIsZ0VBQTZEO0FBQzdELGlFQUF5QztBQUN6Qyw2Q0FBa0Q7QUFDbEQsb0RBQTRCO0FBQzVCLGdFQUErQjtBQVEvQixNQUFNLFFBQVEsR0FBRyxjQUFnQyxDQUFDO0FBQ2xELE1BQU0sa0JBQWtCLEdBQUcsdUJBQW9ELENBQUM7QUFDaEYsTUFBTSxVQUFVLEdBQUcsZ0JBQW9DLENBQUM7QUFDeEQsTUFBTSxPQUFPLEdBQUcsc0JBQThCLENBQUM7QUFFL0MsUUFBUSxDQUFDLGFBQWEsRUFBRSxHQUFHLEVBQUU7SUFDM0IsSUFBSSxXQUF3QixDQUFDO0lBRTdCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxXQUFXLEdBQUcsSUFBSSx5QkFBVyxFQUFFLENBQUM7UUFDaEMsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO0lBQ3ZCLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUU7UUFDMUIsRUFBRSxDQUFDLG1DQUFtQyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ2pELE1BQU0sUUFBUSxHQUFHO2dCQUNmLElBQUksRUFBRSxZQUFZO2dCQUNsQixJQUFJLEVBQUUsZUFBZTtnQkFDckIsS0FBSyxFQUFFLFNBQVM7Z0JBQ2hCLFFBQVEsRUFBRSxhQUFhO2dCQUN2QixJQUFJLEVBQUUsVUFBVTthQUNqQixDQUFDO1lBRUYsTUFBTSxjQUFjLEdBQUcscUJBQXFC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LENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1FBQ3ZHLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyJFOlxcQ3Vyc28gSlNcXERlcGxveVxcQ29tbWVyY2VcXGJhY2tlbmRcXHRlc3RzXFxzZXJ2aWNlc1xcdXNlclNlcnZpY2UudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBVc2VyU2VydmljZSB9IGZyb20gJy4uLy4uL3NyYy9zZXJ2aWNlcy91c2VyU2VydmljZSc7XHJcbmltcG9ydCBVc2VyIGZyb20gJy4uLy4uL3NyYy9tb2RlbHMvVXNlcic7XHJcbmltcG9ydCB7IEN1c3RvbWVyRGV0YWlsIH0gZnJvbSAnLi4vLi4vc3JjL21vZGVscyc7XHJcbmltcG9ydCBiY3J5cHQgZnJvbSAnYmNyeXB0JztcclxuaW1wb3J0IGp3dCBmcm9tICdqc29ud2VidG9rZW4nO1xyXG5cclxuLy8gTW9jayBkb3MgbW9kZWxvc1xyXG5qZXN0Lm1vY2soJy4uLy4uL3NyYy9tb2RlbHMvVXNlcicpO1xyXG5qZXN0Lm1vY2soJy4uLy4uL3NyYy9tb2RlbHMvQ3VzdG9tZXJEZXRhaWwnKTtcclxuamVzdC5tb2NrKCdiY3J5cHQnKTtcclxuamVzdC5tb2NrKCdqc29ud2VidG9rZW4nKTtcclxuXHJcbmNvbnN0IG1vY2tVc2VyID0gVXNlciBhcyBqZXN0Lk1vY2tlZDx0eXBlb2YgVXNlcj47XHJcbmNvbnN0IG1vY2tDdXN0b21lckRldGFpbCA9IEN1c3RvbWVyRGV0YWlsIGFzIGplc3QuTW9ja2VkPHR5cGVvZiBDdXN0b21lckRldGFpbD47XHJcbmNvbnN0IG1vY2tCY3J5cHQgPSBiY3J5cHQgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIGJjcnlwdD47XHJcbmNvbnN0IG1vY2tKd3QgPSBqd3QgYXMgamVzdC5Nb2NrZWQ8dHlwZW9mIGp3dD47XHJcblxyXG5kZXNjcmliZSgnVXNlclNlcnZpY2UnLCAoKSA9PiB7XHJcbiAgbGV0IHVzZXJTZXJ2aWNlOiBVc2VyU2VydmljZTtcclxuXHJcbiAgYmVmb3JlRWFjaCgoKSA9PiB7XHJcbiAgICB1c2VyU2VydmljZSA9IG5ldyBVc2VyU2VydmljZSgpO1xyXG4gICAgamVzdC5jbGVhckFsbE1vY2tzKCk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdjcmVhdGVVc2VyJywgKCkgPT4ge1xyXG4gICAgaXQoJ3Nob3VsZCBjcmVhdGUgYSB1c2VyIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXNlckRhdGEgPSB7XHJcbiAgICAgICAgbmFtZTogJ0pvw6NvIFNpbHZhJyxcclxuICAgICAgICBtYWlsOiAnam9hb0B0ZXN0LmNvbScsXHJcbiAgICAgICAgbG9naW46ICdqb2FvMTIzJyxcclxuICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJyxcclxuICAgICAgICByb2xlOiAnY3VzdG9tZXInXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9ICdoYXNoZWRfcGFzc3dvcmRfMTIzJztcclxuICAgICAgY29uc3QgY3JlYXRlZFVzZXIgPSB7XHJcbiAgICAgICAgaWQ6IDEsXHJcbiAgICAgICAgLi4udXNlckRhdGEsXHJcbiAgICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxyXG4gICAgICAgIGlzX2RlbGV0ZWQ6IGZhbHNlLFxyXG4gICAgICAgIGNyZWF0ZWRfYXQ6IG5ldyBEYXRlKCksXHJcbiAgICAgICAgdXBkYXRlZF9hdDogbmV3IERhdGUoKVxyXG4gICAgICB9O1xyXG5cclxuICAgICAgbW9ja0JjcnlwdC5oYXNoLm1vY2tSZXNvbHZlZFZhbHVlKGhhc2hlZFBhc3N3b3JkIGFzIG5ldmVyKTtcclxuICAgICAgbW9ja1VzZXIuZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuICAgICAgbW9ja1VzZXIuY3JlYXRlLm1vY2tSZXNvbHZlZFZhbHVlKGNyZWF0ZWRVc2VyIGFzIGFueSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VyU2VydmljZS5jcmVhdGVVc2VyKHVzZXJEYXRhKTtcclxuXHJcbiAgICAgIGV4cGVjdChtb2NrQmNyeXB0Lmhhc2gpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHVzZXJEYXRhLnBhc3N3b3JkLCAxMCk7XHJcbiAgICAgIGV4cGVjdChtb2NrVXNlci5maW5kT25lKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgd2hlcmU6IGV4cGVjdC5vYmplY3RDb250YWluaW5nKHtcclxuICAgICAgICAgIFtTeW1ib2wuZm9yKCdvcicpXTogW1xyXG4gICAgICAgICAgICB7IGxvZ2luOiB1c2VyRGF0YS5sb2dpbiB9LFxyXG4gICAgICAgICAgICB7IG1haWw6IHVzZXJEYXRhLm1haWwgfVxyXG4gICAgICAgICAgXVxyXG4gICAgICAgIH0pXHJcbiAgICAgIH0pO1xyXG4gICAgICBleHBlY3QobW9ja1VzZXIuY3JlYXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgLi4udXNlckRhdGEsXHJcbiAgICAgICAgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLFxyXG4gICAgICAgIHJvbGU6ICdjdXN0b21lcidcclxuICAgICAgfSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwoY3JlYXRlZFVzZXIpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciBpZiB1c2VyIGFscmVhZHkgZXhpc3RzJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB1c2VyRGF0YSA9IHtcclxuICAgICAgICBuYW1lOiAnSm/Do28gU2lsdmEnLFxyXG4gICAgICAgIG1haWw6ICdqb2FvQHRlc3QuY29tJyxcclxuICAgICAgICBsb2dpbjogJ2pvYW8xMjMnLFxyXG4gICAgICAgIHBhc3N3b3JkOiAncGFzc3dvcmQxMjMnXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBjb25zdCBleGlzdGluZ1VzZXIgPSB7IGlkOiAxLCBsb2dpbjogJ2pvYW8xMjMnIH07XHJcbiAgICAgIG1vY2tVc2VyLmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUoZXhpc3RpbmdVc2VyIGFzIGFueSk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3QodXNlclNlcnZpY2UuY3JlYXRlVXNlcih1c2VyRGF0YSkpLnJlamVjdHMudG9UaHJvdygnTG9naW4gb3UgZW1haWwgasOhIGV4aXN0ZW0nKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgc2V0IGRlZmF1bHQgcm9sZSBhcyBjdXN0b21lcicsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXNlckRhdGEgPSB7XHJcbiAgICAgICAgbmFtZTogJ0pvw6NvIFNpbHZhJyxcclxuICAgICAgICBtYWlsOiAnam9hb0B0ZXN0LmNvbScsXHJcbiAgICAgICAgbG9naW46ICdqb2FvMTIzJyxcclxuICAgICAgICBwYXNzd29yZDogJ3Bhc3N3b3JkMTIzJ1xyXG4gICAgICB9O1xyXG5cclxuICAgICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSAnaGFzaGVkX3Bhc3N3b3JkXzEyMyc7XHJcbiAgICAgIGNvbnN0IGNyZWF0ZWRVc2VyID0ge1xyXG4gICAgICAgIGlkOiAxLFxyXG4gICAgICAgIC4uLnVzZXJEYXRhLFxyXG4gICAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcclxuICAgICAgICByb2xlOiAnY3VzdG9tZXInXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrQmNyeXB0Lmhhc2gubW9ja1Jlc29sdmVkVmFsdWUoaGFzaGVkUGFzc3dvcmQgYXMgbmV2ZXIpO1xyXG4gICAgICBtb2NrVXNlci5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xyXG4gICAgICBtb2NrVXNlci5jcmVhdGUubW9ja1Jlc29sdmVkVmFsdWUoY3JlYXRlZFVzZXIgYXMgYW55KTtcclxuXHJcbiAgICAgIGF3YWl0IHVzZXJTZXJ2aWNlLmNyZWF0ZVVzZXIodXNlckRhdGEpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tVc2VyLmNyZWF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xyXG4gICAgICAgIC4uLnVzZXJEYXRhLFxyXG4gICAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcclxuICAgICAgICByb2xlOiAnY3VzdG9tZXInXHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdnZXRBbGxVc2VycycsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGFsbCB1c2VycycsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgdXNlcnMgPSBbXHJcbiAgICAgICAgeyBpZDogMSwgbmFtZTogJ0pvw6NvJywgbWFpbDogJ2pvYW9AdGVzdC5jb20nLCByb2xlOiAnY3VzdG9tZXInIH0sXHJcbiAgICAgICAgeyBpZDogMiwgbmFtZTogJ01hcmlhJywgbWFpbDogJ21hcmlhQHRlc3QuY29tJywgcm9sZTogJ2FkbWluJyB9XHJcbiAgICAgIF07XHJcblxyXG4gICAgICBtb2NrVXNlci5maW5kQWxsLm1vY2tSZXNvbHZlZFZhbHVlKHVzZXJzIGFzIGFueSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VyU2VydmljZS5nZXRBbGxVc2VycygpO1xyXG5cclxuICAgICAgZXhwZWN0KG1vY2tVc2VyLmZpbmRBbGwpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcclxuICAgICAgICB3aGVyZTogeyBpc19kZWxldGVkOiBmYWxzZSB9LFxyXG4gICAgICAgIGF0dHJpYnV0ZXM6IHsgZXhjbHVkZTogWydwYXNzd29yZCddIH1cclxuICAgICAgfSk7XHJcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvRXF1YWwodXNlcnMpO1xyXG4gICAgfSk7XHJcbiAgfSk7XHJcblxyXG4gIGRlc2NyaWJlKCdnZXRVc2VyQnlJZCcsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgcmV0dXJuIHVzZXIgYnkgaWQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IHVzZXIgPSB7IGlkOiAxLCBuYW1lOiAnSm/Do28nLCBtYWlsOiAnam9hb0B0ZXN0LmNvbScsIHJvbGU6ICdjdXN0b21lcicgfTtcclxuICAgICAgbW9ja1VzZXIuZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZSh1c2VyIGFzIGFueSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VyU2VydmljZS5nZXRVc2VyQnlJZCgxKTtcclxuXHJcbiAgICAgIGV4cGVjdChtb2NrVXNlci5maW5kT25lKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XHJcbiAgICAgICAgd2hlcmU6IHsgaWQ6IDEsIGlzX2RlbGV0ZWQ6IGZhbHNlIH0sXHJcbiAgICAgICAgYXR0cmlidXRlczogeyBleGNsdWRlOiBbJ3Bhc3N3b3JkJ10gfVxyXG4gICAgICB9KTtcclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh1c2VyKTtcclxuICAgIH0pO1xyXG5cclxuICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3IgaWYgdXNlciBub3QgZm91bmQnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIG1vY2tVc2VyLmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XHJcblxyXG4gICAgICBhd2FpdCBleHBlY3QodXNlclNlcnZpY2UuZ2V0VXNlckJ5SWQoOTk5KSkucmVqZWN0cy50b1Rocm93KCdVc3XDoXJpbyBuw6NvIGVuY29udHJhZG8nKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgndXBkYXRlVXNlcicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgdXBkYXRlIHVzZXIgc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCB1c2VyRGF0YSA9IHsgbmFtZTogJ0pvw6NvIFNhbnRvcycgfTtcclxuICAgICAgY29uc3QgZXhpc3RpbmdVc2VyID0ge1xyXG4gICAgICAgIGlkOiAxLFxyXG4gICAgICAgIG5hbWU6ICdKb8OjbyBTaWx2YScsXHJcbiAgICAgICAgbWFpbDogJ2pvYW9AdGVzdC5jb20nLFxyXG4gICAgICAgIHVwZGF0ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6IDEsIC4uLnVzZXJEYXRhIH0pXHJcbiAgICAgIH07XHJcblxyXG4gICAgICBtb2NrVXNlci5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKGV4aXN0aW5nVXNlciBhcyBhbnkpO1xyXG5cclxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdXNlclNlcnZpY2UudXBkYXRlVXNlcigxLCB1c2VyRGF0YSk7XHJcblxyXG4gICAgICBleHBlY3QoZXhpc3RpbmdVc2VyLnVwZGF0ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgodXNlckRhdGEpO1xyXG4gICAgICBleHBlY3QocmVzdWx0KS50b0VxdWFsKHsgaWQ6IDEsIC4uLnVzZXJEYXRhIH0pO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciBpZiB1c2VyIG5vdCBmb3VuZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgbW9ja1VzZXIuZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdCh1c2VyU2VydmljZS51cGRhdGVVc2VyKDk5OSwgeyBuYW1lOiAnVGVzdCcgfSkpLnJlamVjdHMudG9UaHJvdygnVXN1w6FyaW8gbsOjbyBlbmNvbnRyYWRvJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZGVzY3JpYmUoJ2RlbGV0ZVVzZXInLCAoKSA9PiB7XHJcbiAgICBpdCgnc2hvdWxkIHNvZnQgZGVsZXRlIHVzZXInLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGV4aXN0aW5nVXNlciA9IHtcclxuICAgICAgICBpZDogMSxcclxuICAgICAgICBuYW1lOiAnSm/Do28gU2lsdmEnLFxyXG4gICAgICAgIHVwZGF0ZTogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHsgaWQ6IDEsIGlzX2RlbGV0ZWQ6IHRydWUgfSlcclxuICAgICAgfTtcclxuXHJcbiAgICAgIG1vY2tVc2VyLmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUoZXhpc3RpbmdVc2VyIGFzIGFueSk7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VyU2VydmljZS5kZWxldGVVc2VyKDEpO1xyXG5cclxuICAgICAgZXhwZWN0KGV4aXN0aW5nVXNlci51cGRhdGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHsgaXNfZGVsZXRlZDogdHJ1ZSB9KTtcclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7IG1lc3NhZ2U6ICdVc3XDoXJpbyBkZWxldGFkbyBjb20gc3VjZXNzbycgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGlmIHVzZXIgbm90IGZvdW5kJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBtb2NrVXNlci5maW5kT25lLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KHVzZXJTZXJ2aWNlLmRlbGV0ZVVzZXIoOTk5KSkucmVqZWN0cy50b1Rocm93KCdVc3XDoXJpbyBuw6NvIGVuY29udHJhZG8nKTtcclxuICAgIH0pO1xyXG4gIH0pO1xyXG5cclxuICBkZXNjcmliZSgnYXV0aGVudGljYXRlVXNlcicsICgpID0+IHtcclxuICAgIGl0KCdzaG91bGQgYXV0aGVudGljYXRlIHVzZXIgc3VjY2Vzc2Z1bGx5IHdpdGggdmFsaWQgY3JlZGVudGlhbHMnLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgIGNvbnN0IGxvZ2luID0gJ2pvYW8xMjMnO1xyXG4gICAgICBjb25zdCBwYXNzd29yZCA9ICdwYXNzd29yZDEyMyc7XHJcblxyXG4gICAgICBjb25zdCB1c2VyID0ge1xyXG4gICAgICAgIGlkOiAxLFxyXG4gICAgICAgIG5hbWU6ICdKb8OjbyBTaWx2YScsXHJcbiAgICAgICAgbWFpbDogJ2pvYW9AdGVzdC5jb20nLFxyXG4gICAgICAgIGxvZ2luOiAnam9hbzEyMycsXHJcbiAgICAgICAgcGFzc3dvcmQ6ICdoYXNoZWRfcGFzc3dvcmQnLFxyXG4gICAgICAgIHJvbGU6ICdjdXN0b21lcidcclxuICAgICAgfTtcclxuXHJcbiAgICAgIGNvbnN0IHRva2VuID0gJ2p3dF90b2tlbl8xMjMnO1xyXG5cclxuICAgICAgbW9ja1VzZXIuZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZSh1c2VyIGFzIGFueSk7XHJcbiAgICAgIG1vY2tCY3J5cHQuY29tcGFyZS5tb2NrUmVzb2x2ZWRWYWx1ZSh0cnVlIGFzIG5ldmVyKTtcclxuICAgICAgbW9ja0p3dC5zaWduLm1vY2tSZXR1cm5WYWx1ZSh0b2tlbiBhcyBuZXZlcik7XHJcblxyXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VyU2VydmljZS5hdXRoZW50aWNhdGVVc2VyKGxvZ2luLCBwYXNzd29yZCk7XHJcblxyXG4gICAgICBleHBlY3QobW9ja1VzZXIuZmluZE9uZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xyXG4gICAgICAgIHdoZXJlOiB7IGxvZ2luLCBpc19kZWxldGVkOiBmYWxzZSB9LFxyXG4gICAgICAgIGluY2x1ZGU6IFt7IGFzc29jaWF0aW9uOiAnY3VzdG9tZXJEZXRhaWwnLCByZXF1aXJlZDogZmFsc2UgfV1cclxuICAgICAgfSk7XHJcbiAgICAgIGV4cGVjdChtb2NrQmNyeXB0LmNvbXBhcmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHBhc3N3b3JkLCB1c2VyLnBhc3N3b3JkKTtcclxuICAgICAgZXhwZWN0KG1vY2tKd3Quc2lnbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoXHJcbiAgICAgICAgeyBpZDogdXNlci5pZCwgbG9naW46IHVzZXIubG9naW4sIHJvbGU6IHVzZXIucm9sZSB9LFxyXG4gICAgICAgIHByb2Nlc3MuZW52LkpXVF9TRUNSRVQsXHJcbiAgICAgICAgeyBleHBpcmVzSW46IHByb2Nlc3MuZW52LkpXVF9FWFBJUkVTX0lOIH1cclxuICAgICAgKTtcclxuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7XHJcbiAgICAgICAgdXNlcjoge1xyXG4gICAgICAgICAgaWQ6IHVzZXIuaWQsXHJcbiAgICAgICAgICBuYW1lOiB1c2VyLm5hbWUsXHJcbiAgICAgICAgICBtYWlsOiB1c2VyLm1haWwsXHJcbiAgICAgICAgICBsb2dpbjogdXNlci5sb2dpbixcclxuICAgICAgICAgIHJvbGU6IHVzZXIucm9sZVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgdG9rZW5cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGZvciBpbnZhbGlkIGxvZ2luJywgYXN5bmMgKCkgPT4ge1xyXG4gICAgICBjb25zdCBsb2dpbiA9ICdpbnZhbGlkJztcclxuICAgICAgY29uc3QgcGFzc3dvcmQgPSAncGFzc3dvcmQxMjMnO1xyXG5cclxuICAgICAgbW9ja1VzZXIuZmluZE9uZS5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcclxuXHJcbiAgICAgIGF3YWl0IGV4cGVjdCh1c2VyU2VydmljZS5hdXRoZW50aWNhdGVVc2VyKGxvZ2luLCBwYXNzd29yZCkpLnJlamVjdHMudG9UaHJvdygnQ3JlZGVuY2lhaXMgaW52w6FsaWRhcycpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoJ3Nob3VsZCB0aHJvdyBlcnJvciBmb3IgaW52YWxpZCBwYXNzd29yZCcsIGFzeW5jICgpID0+IHtcclxuICAgICAgY29uc3QgbG9naW4gPSAnam9hbzEyMyc7XHJcbiAgICAgIGNvbnN0IHBhc3N3b3JkID0gJ3dyb25nX3Bhc3N3b3JkJztcclxuXHJcbiAgICAgIGNvbnN0IHVzZXIgPSB7XHJcbiAgICAgICAgaWQ6IDEsXHJcbiAgICAgICAgbmFtZTogJ0pvw6NvIFNpbHZhJyxcclxuICAgICAgICBwYXNzd29yZDogJ2hhc2hlZF9wYXNzd29yZCdcclxuICAgICAgfTtcclxuXHJcbiAgICAgIG1vY2tVc2VyLmZpbmRPbmUubW9ja1Jlc29sdmVkVmFsdWUodXNlciBhcyBhbnkpO1xyXG4gICAgICBtb2NrQmNyeXB0LmNvbXBhcmUubW9ja1Jlc29sdmVkVmFsdWUoZmFsc2UgYXMgbmV2ZXIpO1xyXG5cclxuICAgICAgYXdhaXQgZXhwZWN0KHVzZXJTZXJ2aWNlLmF1dGhlbnRpY2F0ZVVzZXIobG9naW4sIHBhc3N3b3JkKSkucmVqZWN0cy50b1Rocm93KCdDcmVkZW5jaWFpcyBpbnbDoWxpZGFzJyk7XHJcbiAgICB9KTtcclxuICB9KTtcclxufSk7XHJcbiJdLCJ2ZXJzaW9uIjozfQ==